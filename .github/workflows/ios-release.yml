name: Release iOS to TestFlight

on:
  push:
    branches:
      - main

jobs:
  ios-release:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      EXPO_APP_STORE_CONNECT_API_KEY: ${{ secrets.EXPO_APP_STORE_CONNECT_API_KEY }}
      EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_ASC_APP_ID: ${{ secrets.APPLE_ASC_APP_ID }}
      EAS_NO_VCS_WARNING: 1
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          test -n "$EXPO_TOKEN" || { echo 'Missing EXPO_TOKEN secret' >&2; exit 1; }
          test -n "$APPLE_TEAM_ID" || { echo 'Missing APPLE_TEAM_ID secret' >&2; exit 1; }
          test -n "$APPLE_ASC_APP_ID" || { echo 'Missing APPLE_ASC_APP_ID secret' >&2; exit 1; }
          if [ -z "$EXPO_APP_STORE_CONNECT_API_KEY" ] && [ -z "$EXPO_APPLE_APP_SPECIFIC_PASSWORD" ]; then
            echo 'Provide either EXPO_APP_STORE_CONNECT_API_KEY (preferred) or EXPO_APPLE_APP_SPECIFIC_PASSWORD secret' >&2
            exit 1
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install --global eas-cli

      - name: Configure Expo
        uses: expo/expo-github-action@v8
        with:
          expo-cache: true
          eas-cache: true
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Inject App Store Connect metadata
        run: |
          jq '.submit.production.ios.ascAppId = env.APPLE_ASC_APP_ID | .submit.production.ios.appleTeamId = env.APPLE_TEAM_ID' eas.json > eas.tmp.json
          mv eas.tmp.json eas.json

      - name: Build and submit iOS release
        run: |
          eas build --platform ios --profile production --non-interactive --wait --auto-submit --submit-profile production
